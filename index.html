<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio Viewer (Excel → Web)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --fg: #e7edf3;
      --muted: #9fb0c0;
      --card: #121821;
      --accent: #4cc9f0;
      --good: #2ecc71;
      --bad: #e74c3c;
      --border: #1d2733;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; 
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #18202b 100%);
      color: var(--fg);
      line-height: 1.5;
    }

    header {
      padding: 20px;
      display: flex; 
      flex-wrap: wrap; 
      gap: 16px; 
      align-items: center; 
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    
    .title {
      display: flex; 
      align-items: center; 
      gap: 12px; 
      font-weight: 700; 
      font-size: 1.2rem;
    }
    
    .title .dot { 
      width: 10px; 
      height: 10px; 
      border-radius: 50%; 
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }

    .controls { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
    }
    
    .file {
      background: var(--card); 
      border: 2px dashed var(--border); 
      padding: 8px 12px; 
      border-radius: 8px; 
      color: var(--muted);
      cursor: pointer;
    }
    
    .btn {
      background: var(--accent);
      border: none; 
      color: white; 
      padding: 10px 16px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600;
    }
    
    .btn:hover {
      background: #3ba8d1;
    }

    main { 
      padding: 20px; 
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .cards { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 16px; 
    }
    
    .card { 
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 16px; 
    }
    
    .card h4 { 
      margin: 0 0 8px; 
      font-size: 0.9rem; 
      color: var(--muted); 
      font-weight: 500; 
    }
    
    .card .val { 
      font-size: 1.4rem; 
      font-weight: 700; 
      margin: 0;
    }

    .table-container { 
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      overflow: hidden; 
    }
    
    .table-header { 
      padding: 16px; 
      border-bottom: 1px solid var(--border); 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .table-title { 
      font-weight: 700; 
      font-size: 1.1rem;
    }
    
    .hint { 
      color: var(--muted); 
      font-size: 0.85rem; 
    }

    .table-scroll { 
      overflow: auto; 
      max-height: 500px; 
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.9rem; 
    }
    
    th, td { 
      padding: 12px; 
      text-align: left; 
      border-bottom: 1px solid var(--border); 
    }
    
    th { 
      background: var(--bg); 
      font-weight: 600; 
      position: sticky; 
      top: 0;
      cursor: pointer;
    }
    
    th:hover {
      background: #0f1419;
    }
    
    .num { 
      text-align: right; 
    }
    
    .pos { 
      color: var(--good); 
    }
    
    .neg { 
      color: var(--bad); 
    }

    footer { 
      padding: 20px; 
      text-align: center; 
      color: var(--muted); 
      font-size: 0.85rem; 
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .error {
      background: rgba(231, 76, 60, 0.1);
      border: 1px solid var(--bad);
      color: var(--bad);
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      Visualizador de Portfolio
    </div>
    <div class="controls">
      <input id="fileInput" class="file" type="file" accept=".xlsx,.xls,.csv" />
    </div>
  </header>

  <main>
    <div class="cards">
      <div class="card">
        <h4>Valor Investido</h4>
        <div class="val" id="investido">—</div>
      </div>
      <div class="card">
        <h4>Valor Atual</h4>
        <div class="val" id="atual">—</div>
      </div>
      <div class="card">
        <h4>P&L Total</h4>
        <div class="val" id="pl">—</div>
      </div>
      <div class="card">
        <h4>Ativos</h4>
        <div class="val" id="ativos">—</div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <div class="table-title">Posições</div>
      </div>
      <div class="table-scroll">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="100%" class="loading">Carregue um arquivo .xlsx, .xls ou .csv</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    console.log('Iniciando Portfolio Viewer...');

    // Formatadores
    const formatBRL = (value) => {
      if (typeof value !== 'number' || isNaN(value)) return '—';
      return value.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      });
    };

    const formatNumber = (value, decimals = 2) => {
      if (typeof value !== 'number' || isNaN(value)) return '—';
      return value.toLocaleString('pt-BR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    };

    const formatPercent = (value) => {
      if (typeof value !== 'number' || isNaN(value)) return '—';
      return formatNumber(value) + '%';
    };

    // Conversão de string para número
    const parseNumber = (str) => {
      if (typeof str === 'number') return str;
      if (!str || str === '') return NaN;
      
      let clean = String(str).trim();
      // Remove caracteres não numéricos exceto vírgulas, pontos e sinais
      clean = clean.replace(/[^\d,.-]/g, '');
      
      // Se tem vírgula, assume formato brasileiro (vírgula = decimal)
      if (clean.includes(',')) {
        // Remove pontos (milhares) e troca vírgula por ponto
        clean = clean.replace(/\./g, '').replace(',', '.');
      }
      
      const num = parseFloat(clean);
      return isFinite(num) ? num : NaN;
    };

    // Elementos DOM
    const fileInput = document.getElementById('fileInput');
    const investidoEl = document.getElementById('investido');
    const atualEl = document.getElementById('atual');
    const plEl = document.getElementById('pl');
    const ativosEl = document.getElementById('ativos');
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');

    // Event listeners
    fileInput.addEventListener('change', handleFileInput);

    // Manipula upload de arquivo
    function handleFileInput(event) {
      const file = event.target.files[0];
      if (!file) return;

      console.log('Arquivo selecionado:', file.name);
      
      const extension = file.name.split('.').pop().toLowerCase();
      
      if (['xlsx', 'xls'].includes(extension)) {
        readExcelFile(file);
      } else if (extension === 'csv') {
        readCSVFile(file);
      } else {
        showError('Formato não suportado. Use .xlsx, .xls ou .csv');
      }
    }

    // Lê arquivo Excel
    function readExcelFile(file) {
      console.log('Lendo arquivo Excel...');
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          if (workbook.SheetNames.length === 0) {
            showError('Planilha vazia');
            return;
          }

          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          console.log('Dados extraídos:', jsonData);
          
          if (jsonData.length === 0) {
            showError('Nenhum dado encontrado na planilha');
            return;
          }
          
          processData(jsonData);
        } catch (error) {
          console.error('Erro ao ler Excel:', error);
          showError('Erro ao processar arquivo Excel: ' + error.message);
        }
      };
      
      reader.onerror = () => showError('Erro ao ler arquivo');
      reader.readAsArrayBuffer(file);
    }

    // Lê arquivo CSV
    function readCSVFile(file) {
      console.log('Lendo arquivo CSV...');
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const lines = text.trim().split('\n');
          
          if (lines.length < 2) {
            showError('CSV deve ter pelo menos cabeçalho e uma linha de dados');
            return;
          }
          
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          const data = [];
          
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
            const row = {};
            headers.forEach((header, index) => {
              row[header] = values[index] || '';
            });
            data.push(row);
          }
          
          console.log('Dados CSV extraídos:', data);
          processData(data);
        } catch (error) {
          console.error('Erro ao ler CSV:', error);
          showError('Erro ao processar arquivo CSV: ' + error.message);
        }
      };
      
      reader.onerror = () => showError('Erro ao ler arquivo CSV');
      reader.readAsText(file, 'utf-8');
    }

    // Processa os dados
    function processData(rawData) {
      console.log('Processando dados...');
      
      if (!Array.isArray(rawData) || rawData.length === 0) {
        showError('Dados inválidos');
        return;
      }

      // Normaliza e valida dados
      const processedData = [];
      
      rawData.forEach((row, index) => {
        // Busca diferentes variações de nomes de colunas
        const ativo = findColumn(row, ['Ativo', 'ativo', 'Ticker', 'ticker', 'Symbol', 'Papel']);
        const quantidade = findColumn(row, ['Quantidade', 'quantidade', 'Qty', 'Qtd']);
        const precoMedio = findColumn(row, ['Preço_Médio', 'Preco_Medio', 'Preço Médio', 'Average_Price']);
        const precoAtual = findColumn(row, ['Preço_Atual', 'Preco_Atual', 'Preço Atual', 'Current_Price', 'Last', 'Close']);

        if (!ativo || !quantidade || !precoMedio) {
          console.warn(`Linha ${index + 1} ignorada: dados obrigatórios faltando`);
          return;
        }

        const qtd = parseNumber(quantidade);
        const pMedio = parseNumber(precoMedio);
        const pAtual = parseNumber(precoAtual);

        if (isNaN(qtd) || isNaN(pMedio) || qtd <= 0 || pMedio <= 0) {
          console.warn(`Linha ${index + 1} ignorada: valores inválidos`);
          return;
        }

        const valorInvestido = qtd * pMedio;
        const valorAtual = !isNaN(pAtual) ? qtd * pAtual : NaN;
        const pl = !isNaN(valorAtual) ? valorAtual - valorInvestido : NaN;
        const plPercent = !isNaN(pl) && valorInvestido > 0 ? (pl / valorInvestido) * 100 : NaN;

        processedData.push({
          ativo: String(ativo).trim(),
          quantidade: qtd,
          precoMedio: pMedio,
          precoAtual: pAtual,
          valorInvestido: valorInvestido,
          valorAtual: valorAtual,
          pl: pl,
          plPercent: plPercent
        });
      });

      if (processedData.length === 0) {
        showError('Nenhum dado válido encontrado. Verifique as colunas: Ativo, Quantidade, Preço_Médio');
        return;
      }

      console.log('Dados processados:', processedData);
      
      // Calcula totais
      const totalInvestido = processedData.reduce((sum, item) => sum + item.valorInvestido, 0);
      const totalAtual = processedData.reduce((sum, item) => sum + (item.valorAtual || 0), 0);
      const totalPL = totalAtual - totalInvestido;
      const totalPLPercent = totalInvestido > 0 ? (totalPL / totalInvestido) * 100 : 0;

      // Adiciona peso
      processedData.forEach(item => {
        item.peso = item.valorAtual && totalAtual > 0 ? (item.valorAtual / totalAtual) * 100 : NaN;
      });

      // Atualiza interface
      updateSummary(totalInvestido, totalAtual, totalPL, totalPLPercent, processedData.length);
      updateTable(processedData);
    }

    // Busca coluna por diferentes nomes
    function findColumn(row, possibleNames) {
      for (const name of possibleNames) {
        if (row.hasOwnProperty(name) && row[name] !== null && row[name] !== '') {
          return row[name];
        }
      }
      return null;
    }

    // Atualiza resumo
    function updateSummary(totalInvestido, totalAtual, totalPL, totalPLPercent, numAtivos) {
      investidoEl.textContent = formatBRL(totalInvestido);
      atualEl.textContent = formatBRL(totalAtual);
      
      const plText = `${formatBRL(totalPL)} (${formatPercent(totalPLPercent)})`;
      plEl.textContent = plText;
      plEl.className = 'val ' + (totalPL >= 0 ? 'pos' : 'neg');
      
      ativosEl.textContent = numAtivos.toString();
    }

    // Atualiza tabela
    function updateTable(data) {
      // Cabeçalho
      tableHead.innerHTML = `
        <tr>
          <th>Ativo</th>
          <th class="num">Quantidade</th>
          <th class="num">Preço Médio</th>
          <th class="num">Preço Atual</th>
          <th class="num">Valor Investido</th>
          <th class="num">Valor Atual</th>
          <th class="num">P&L (R$)</th>
          <th class="num">P&L (%)</th>
          <th class="num">Peso (%)</th>
        </tr>
      `;

      // Corpo da tabela
      tableBody.innerHTML = data.map(item => `
        <tr>
          <td>${item.ativo}</td>
          <td class="num">${formatNumber(item.quantidade, 0)}</td>
          <td class="num">${formatBRL(item.precoMedio)}</td>
          <td class="num">${formatBRL(item.precoAtual)}</td>
          <td class="num">${formatBRL(item.valorInvestido)}</td>
          <td class="num">${formatBRL(item.valorAtual)}</td>
          <td class="num ${item.pl >= 0 ? 'pos' : 'neg'}">${formatBRL(item.pl)}</td>
          <td class="num ${item.plPercent >= 0 ? 'pos' : 'neg'}">${formatPercent(item.plPercent)}</td>
          <td class="num">${formatPercent(item.peso)}</td>
        </tr>
      `).join('');
    }

    // Mostra erro
    function showError(message) {
      console.error('Erro:', message);
      tableBody.innerHTML = `
        <tr>
          <td colspan="100%" class="error">${message}</td>
        </tr>
      `;
    }

    console.log('Portfolio Viewer carregado');
  </script>
</body>
</html>